<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        åˆ˜è®­ç¼çš„å­ç«™ğŸ 
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            RNNæˆé•¿è®°(äºŒ)ï¼šæ–‡æœ¬åˆ†ç±»ğŸ”¥
        </p>
        <hr>
    </div>
    <div class="post-content">
        <blockquote>
<p>åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨ TensorFlow å®ç°ä¸€ä¸ªç®€å•çš„ RNN æ¶æ„ã€‚ç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›ç»„ä»¶å¹¶å°†å…¶åº”ç”¨åˆ°æ–‡æœ¬åˆ†ç±»ä¸­å»ã€‚ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬ä¸ä¼šåƒ CHAR-RNN æ¨¡å‹é‚£æ ·è¾“å…¥å›ºå®šé•¿åº¦çš„åºåˆ—ï¼Œè€Œæ˜¯ä½¿ç”¨é•¿åº¦ä¸åŒçš„åºåˆ—ã€‚</p>
</blockquote>
<h2 id="æ–‡æœ¬åˆ†ç±»"><a href="#æ–‡æœ¬åˆ†ç±»" class="headerlink" title="æ–‡æœ¬åˆ†ç±»"></a>æ–‡æœ¬åˆ†ç±»</h2><p>è¿™ä¸ªä»»åŠ¡çš„æ•°æ®é›†é€‰ç”¨äº†æ¥è‡ª Cornell å¤§å­¦çš„è¯­å¥æƒ…ç»ªææ€§æ•°æ®é›†ï¼Œå®ƒåŒ…å«äº† 5331 ä¸ªæ­£é¢å’Œè´Ÿé¢æƒ…ç»ªçš„å¥å­ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å°çš„æ•°æ®é›†ï¼Œä½†è¶³å¤Ÿç”¨æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å¾ªç¯ç¥ç»ç½‘ç»œè¿›è¡Œæ–‡æœ¬åˆ†ç±»äº†ã€‚</p>
<h2 id="é¢„å¤„ç†æ­¥éª¤"><a href="#é¢„å¤„ç†æ­¥éª¤" class="headerlink" title="é¢„å¤„ç†æ­¥éª¤"></a>é¢„å¤„ç†æ­¥éª¤</h2><ol>
<li>æ¸…æ´—å¥å­å¹¶åˆ‡åˆ†æˆä¸€ä¸ªä¸ª tokenï¼›</li>
<li>å°†å¥å­è½¬æ¢ä¸ºæ•°å€¼ tokenï¼›</li>
<li>ä¿å­˜æ¯ä¸ªå¥å­çš„åºåˆ—é•¿ã€‚</li>
</ol>
<p><img src="https://picreso.oss-cn-beijing.aliyuncs.com/68747470733a2f2f7468656e657572616c70657273706563746976652e66696c65732e776f726470726573732e636f6d2f323031362f31302f73637265656e2d73686f742d323031362d31302d30352d61742d372d33322d33362d706d2e706e673f773d363230.png" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨è®¡ç®—å®Œæˆæ—¶ç«‹å³å¯¹å¥å­çš„æƒ…ç»ªåšå‡ºé¢„æµ‹ã€‚å¼•å…¥é¢å¤–çš„å¡«å……ç¬¦ä¼šå¸¦æ¥è¿‡å¤šå™ªå£°ï¼Œè¿™æ ·çš„è¯ä½ æ¨¡å‹çš„æ€§èƒ½å°±ä¼šä¸å¤ªå¥½ã€‚<strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬å¡«å……åºåˆ—çš„å”¯ä¸€åŸå› æ˜¯å› ä¸ºéœ€è¦ä»¥å›ºå®šå¤§å°çš„æ‰¹é‡è¾“å…¥è¿› RNNã€‚ä¸‹é¢ä½ ä¼šçœ‹åˆ°ï¼Œä½¿ç”¨åŠ¨æ€ RNN è¿˜èƒ½é¿å…åœ¨åºåˆ—å®Œæˆåçš„ä¸å¿…è¦è®¡ç®—ã€‚</p>
<h2 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h2><p>ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">model</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, FLAGS)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å ä½ç¬¦</span></span><br><span class="line">        self.inputs_X = tf.placeholder(tf.int32,</span><br><span class="line">            shape=[<span class="literal">None</span>, <span class="literal">None</span>], name=<span class="string">'inputs_X'</span>)</span><br><span class="line">        self.targets_y = tf.placeholder(tf.float32,</span><br><span class="line">            shape=[<span class="literal">None</span>, <span class="literal">None</span>], name=<span class="string">'targets_y'</span>)</span><br><span class="line">        self.dropout = tf.placeholder(tf.float32)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># RNN å•å…ƒ</span></span><br><span class="line">        stacked_cell = rnn_cell(FLAGS, self.dropout)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># RNN è¾“å…¥</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'rnn_inputs'</span>):</span><br><span class="line">            W_input = tf.get_variable(<span class="string">"W_input"</span>,</span><br><span class="line">                [FLAGS.en_vocab_size, FLAGS.num_hidden_units])</span><br><span class="line"></span><br><span class="line">        inputs = rnn_inputs(FLAGS, self.inputs_X)</span><br><span class="line">        <span class="comment">#initial_state = stacked_cell.zero_state(FLAGS.batch_size, tf.float32)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># RNN è¾“å‡º</span></span><br><span class="line">        seq_lens = length(self.inputs_X)</span><br><span class="line">        all_outputs, state = tf.nn.dynamic_rnn(cell=stacked_cell, inputs=inputs,</span><br><span class="line">            sequence_length=seq_lens, dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”±äºä½¿ç”¨äº† seq_len[0]ï¼Œstate è‡ªåŠ¨åŒ…å«äº†ä¸Šä¸€æ¬¡çš„å¯¹åº”è¾“å‡º</span></span><br><span class="line">        <span class="comment"># å› ä¸º state æ˜¯ä¸€ä¸ªå¸¦æœ‰å¼ é‡çš„å…ƒç»„</span></span><br><span class="line">        outputs = state[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¤„ç† RNN è¾“å‡º</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'rnn_softmax'</span>):</span><br><span class="line">            W_softmax = tf.get_variable(<span class="string">"W_softmax"</span>,</span><br><span class="line">                [FLAGS.num_hidden_units, FLAGS.num_classes])</span><br><span class="line">            b_softmax = tf.get_variable(<span class="string">"b_softmax"</span>, [FLAGS.num_classes])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logits</span></span><br><span class="line">        logits = rnn_softmax(FLAGS, outputs)</span><br><span class="line">        probabilities = tf.nn.softmax(logits)</span><br><span class="line">        self.accuracy = tf.equal(tf.argmax(</span><br><span class="line">            self.targets_y,<span class="number">1</span>), tf.argmax(logits,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æŸå¤±å‡½æ•°</span></span><br><span class="line">        self.loss = tf.reduce_mean(</span><br><span class="line">            tf.nn.sigmoid_cross_entropy_with_logits(logits, self.targets_y))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¼˜åŒ–</span></span><br><span class="line">        self.lr = tf.Variable(<span class="number">0.0</span>, trainable=<span class="literal">False</span>)</span><br><span class="line">        trainable_vars = tf.trainable_variables()</span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ¢¯åº¦æˆªæ–­æ¥é¿å…æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸</span></span><br><span class="line">        grads, _ = tf.clip_by_global_norm(</span><br><span class="line">            tf.gradients(self.loss, trainable_vars), FLAGS.max_gradient_norm)</span><br><span class="line">        optimizer = tf.train.AdamOptimizer(self.lr)</span><br><span class="line">        self.train_optimizer = optimizer.apply_gradients(</span><br><span class="line">            zip(grads, trainable_vars))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¸‹é¢æ˜¯ç”¨äºé‡‡æ ·çš„å€¼</span></span><br><span class="line">        <span class="comment"># (åœ¨æ¯ä¸ªå•è¯åç”Ÿæˆæƒ…ç»ª)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å–æ‰€æœ‰è¾“å‡ºä½œä¸ºç¬¬ä¸€ä¸ªè¾“å…¥åºåˆ—</span></span><br><span class="line">        <span class="comment"># (ç”±äºé‡‡æ ·ï¼Œåªéœ€ä¸€ä¸ªè¾“å…¥åºåˆ—)</span></span><br><span class="line">        sampling_outputs = all_outputs[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logits</span></span><br><span class="line">        sampling_logits = rnn_softmax(FLAGS, sampling_outputs)</span><br><span class="line">        self.sampling_probabilities = tf.nn.softmax(sampling_logits)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜æ¨¡å‹çš„ç»„ä»¶</span></span><br><span class="line">        self.global_step = tf.Variable(<span class="number">0</span>, trainable=<span class="literal">False</span>)</span><br><span class="line">        self.saver = tf.train.Saver(tf.all_variables())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(self, sess, batch_X, batch_y=None, dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        forward_only=True, sampling=False)</span>:</span></span><br><span class="line"></span><br><span class="line">        input_feed = &#123;self.inputs_X: batch_X,</span><br><span class="line">                      self.targets_y: batch_y,</span><br><span class="line">                      self.dropout: dropout&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> forward_only:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sampling:</span><br><span class="line">                output_feed = [self.loss,</span><br><span class="line">                               self.accuracy]</span><br><span class="line">            <span class="keyword">elif</span> sampling:</span><br><span class="line">                input_feed = &#123;self.inputs_X: batch_X,</span><br><span class="line">                              self.dropout: dropout&#125;</span><br><span class="line">                output_feed = [self.sampling_probabilities]</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># è®­ç»ƒ</span></span><br><span class="line">            output_feed = [self.train_optimizer,</span><br><span class="line">                           self.loss,</span><br><span class="line">                           self.accuracy]</span><br><span class="line"></span><br><span class="line">        outputs = sess.run(output_feed, input_feed)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> forward_only:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sampling:</span><br><span class="line">                <span class="keyword">return</span> outputs[<span class="number">0</span>], outputs[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">elif</span> sampling:</span><br><span class="line">                <span class="keyword">return</span> outputs[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># è®­ç»ƒ</span></span><br><span class="line">            <span class="keyword">return</span> outputs[<span class="number">0</span>], outputs[<span class="number">1</span>], outputs[<span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯æˆ‘ä»¬çš„æ¨¡å‹ä»£ç ï¼Œå®ƒåœ¨è®­ç»ƒçš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†è¾“å…¥çš„æ–‡æœ¬ã€‚<strong>æ³¨æ„</strong>ï¼šä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬å†³å®šå°†æ‰¹é‡æ•°æ®çš„å¤§å°ä¿å­˜åœ¨æˆ‘ä»¬çš„è¾“å…¥å’Œç›®æ ‡å ä½ç¬¦ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥è®©å®ƒä»¬ç‹¬ç«‹äºä¸€ä¸ªç‰¹å®šçš„æ‰¹é‡å¤§å°ä¹‹å¤–ã€‚ç”±äºè¿™ä¸ªç‰¹å®šçš„æ‰¹é‡å¤§å°ä¾èµ–äº <code>batch_size</code>ï¼Œå¦‚æœæˆ‘ä»¬è¿™ä¹ˆåšï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¿˜å¾—è¾“å…¥ä¸€ä¸ª <code>initial_state</code>ã€‚æˆ‘ä»¬é€šè¿‡åµŒå…¥ä»–ä»¬æ¥ä¸ºæ¯ä¸ªæ•°æ®åºåˆ—æ¥è¾“å…¥ tokenã€‚å®è·µç­–ç•¥è¡¨æ˜ï¼Œæˆ‘ä»¬åœ¨è¾“å…¥æ–‡æœ¬ä¸Šä½¿ç”¨ skip-gram æ¨¡å‹é¢„è®­ç»ƒåµŒå…¥æƒé‡èƒ½å¤Ÿå–å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨ <code>dynamic_rnn</code>ï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘ä»¬æä¾›äº†<code>sequence_length</code> å‚æ•°çš„å€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«æ¯ä¸ªåºåˆ—é•¿åº¦çš„åˆ—è¡¨ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¿å…åœ¨è¾“å…¥åºåˆ—çš„æœ€åä¸€ä¸ªè¯ä¹‹åè¿›è¡Œçš„ä¸å¿…è¦çš„è®¡ç®—ã€‚<strong><code>length</code></strong> å‡½æ•°å°±ç”¨æ¥è·å–è¿™ä¸ªåˆ—è¡¨çš„é•¿åº¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å¤–é¢è®¡ç®—<code>seq_len</code>ï¼Œå†é€šè¿‡å ä½ç¬¦è¿›è¡Œä¼ é€’ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">length</span><span class="params">(data)</span>:</span></span><br><span class="line">	relevant = tf.sign(tf.abs(data))</span><br><span class="line">	length = tf.reduce_sum(relevant, reduction_indices=<span class="number">1</span>)</span><br><span class="line">	length = tf.cast(length, tf.int32)</span><br><span class="line">	<span class="keyword">return</span> length</span><br></pre></td></tr></table></figure>

<p>ç”±äºæˆ‘ä»¬å¡«å……ç¬¦ token ä¸º 0ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ¯ä¸ª token çš„ sign æ€§è´¨æ¥ç¡®å®šå®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå¡«å……ç¬¦ tokenã€‚å¦‚æœè¾“å…¥å¤§äº 0ï¼Œåˆ™ <code>tf.sign</code> ä¸º 1ï¼›å¦‚æœè¾“å…¥ä¸º 0ï¼Œåˆ™ä¸º <code>tf.sign</code> ä¸º 0ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€æ­¥é€šè¿‡åˆ—ç´¢å¼•æ¥è·å¾— sign å€¼ä¸ºæ­£çš„ token æ•°é‡ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªé•¿åº¦æä¾›ç»™ <code>dynamic_rnn</code> äº†ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å¤–éƒ¨è®¡ç®— <code>seq_lens</code>ï¼Œå¹¶å°†å…¶ä½œä¸ºå ä½ç¬¦è¿›è¡Œä¼ å‚ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨ä¾èµ–äº <code>PAD_ID = 0</code> è¿™ä¸ªæ€§è´¨äº†ã€‚</p>
<p>ä¸€æ—¦æˆ‘ä»¬ä» RNN æ‹¿åˆ°äº†æ‰€æœ‰çš„è¾“å‡ºå’Œæœ€ç»ˆçŠ¶æ€ï¼Œæˆ‘ä»¬å°±ä¼šå¸Œæœ›åˆ†ç¦»å¯¹åº”è¾“å‡ºã€‚å¯¹äºæ¯ä¸ªè¾“å…¥æ¥è¯´ï¼Œå°†å…·æœ‰ä¸åŒçš„å¯¹åº”è¾“å‡ºï¼Œå› ä¸ºæ¯ä¸ªè¾“å…¥é•¿åº¦ä¸ä¸€å®šä¸ç›¸åŒã€‚ç”±äºæˆ‘ä»¬å°† <code>seq_len</code> ä¼ ç»™äº† <code>dynamic_rnn</code>ï¼Œè€Œ <code>state</code> åˆæ˜¯æœ€åä¸€ä¸ªå¯¹åº”è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹ <code>state</code> æ¥æ‰¾åˆ°å¯¹åº”è¾“å‡ºã€‚æ³¨æ„ï¼Œæˆ‘ä»¬å¿…é¡»å– <code>state[0]</code>ï¼Œå› ä¸ºè¿”å›çš„ <code>state</code> æ˜¯ä¸€ä¸ªå¼ é‡çš„å…ƒç»„ã€‚</p>
<p>å…¶ä»–éœ€è¦æ³¨æ„çš„äº‹æƒ…ï¼šæˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨ <strong><code>initial_state</code></strong>ï¼Œè€Œæ˜¯ç›´æ¥ç»™ <code>dynamic_rnn</code> è®¾ç½® <code>dtype</code>ã€‚æ­¤å¤–ï¼Œ<code>dropout</code> å°†æ ¹æ® <code>forward_only</code> ä¸å¦ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™ <strong><code>step()</code></strong>ã€‚</p>
<h2 id="æ¨æ–­"><a href="#æ¨æ–­" class="headerlink" title="æ¨æ–­"></a>æ¨æ–­</h2><p>æ€»çš„æ¥è¯´ï¼Œé™¤äº†å•ä¸ªå¥å­çš„é¢„æµ‹å¤–ï¼Œæˆ‘è¿˜æƒ³ä¸ºå…·æœ‰ä¸€å †æ ·æœ¬å¥å­æ•´ä½“æƒ…ç»ªè¿›è¡Œé¢„æµ‹ã€‚æˆ‘å¸Œæœ›çœ‹åˆ°çš„æ˜¯ï¼Œæ¯ä¸ªå•è¯éƒ½è¢« RNN è¯»å–åï¼Œå°†ä¹‹å‰çš„å•è¯åˆ†å€¼ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä»è€ŒæŸ¥çœ‹é¢„æµ‹åˆ†å€¼æ˜¯æ€æ ·å˜åŒ–çš„ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼ˆå€¼è¶Šæ¥è¿‘ 0 è¡¨æ˜è¶Šé è¿‘è´Ÿé¢æƒ…ç»ªï¼‰ï¼š</p>
<p><img src="https://picreso.oss-cn-beijing.aliyuncs.com/68747470733a2f2f7468656e657572616c70657273706563746976652e66696c65732e776f726470726573732e636f6d2f323031362f31302f73637265656e2d73686f742d323031362d31302d30352d61742d382d33342d35312d706d2e706e673f773d363230.png" alt=""></p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ¨¡å‹ï¼Œå…¶æ•°æ®é›†éå¸¸æœ‰é™ã€‚ä¸»è¦ç›®çš„åªæ˜¯ä¸ºäº†é˜æ˜å®ƒæ˜¯å¦‚ä½•æ­å»ºä»¥åŠå¦‚ä½•è¿è¡Œçš„ã€‚ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨æ•°æ®é‡æ›´å¤§çš„æ•°æ®é›†ï¼Œå¹¶è€ƒè™‘å…·ä½“çš„ç½‘ç»œæ¶æ„ï¼Œæ¯”å¦‚ Attention æ¨¡å‹ã€Concept-Aware è¯åµŒå…¥ä»¥åŠéšå–»ï¼ˆsymbolization to nameï¼‰ç­‰ç­‰ã€‚</p>
<h2 id="æŸå¤±å±è”½ï¼ˆè¿™é‡Œä¸éœ€è¦ï¼‰"><a href="#æŸå¤±å±è”½ï¼ˆè¿™é‡Œä¸éœ€è¦ï¼‰" class="headerlink" title="æŸå¤±å±è”½ï¼ˆè¿™é‡Œä¸éœ€è¦ï¼‰"></a>æŸå¤±å±è”½ï¼ˆè¿™é‡Œä¸éœ€è¦ï¼‰</h2><p>æœ€åï¼Œæˆ‘ä»¬æ¥è®¡ç®— costã€‚ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°æˆ‘ä»¬æ²¡æœ‰åšä»»ä½•æŸå¤±å±è”½ï¼ˆloss maskingï¼‰å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬åˆ†ç¦»äº†å¯¹åº”è¾“å‡ºï¼Œä»…ç”¨äºè®¡ç®—æŸå¤±å‡½æ•°ã€‚ç„¶è€Œï¼Œå¯¹äºå…¶ä»–è¯¸å¦‚æœºå™¨ç¿»è¯‘çš„ä»»åŠ¡æ¥è¯´ï¼Œæˆ‘ä»¬çš„è¾“å‡ºå¾ˆæœ‰å¯èƒ½è¿˜æ¥è‡ªå¡«å……ç¬¦ tokenã€‚æˆ‘ä»¬ä¸æƒ³è€ƒè™‘è¿™äº›è¾“å‡ºï¼Œå› ä¸ºä¼ é€’äº† <code>seq_lens</code> å‚æ•°çš„ <code>dynamic_rnn</code> å°†è¿”å› 0ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œåªç”¨æ¥è¯´æ˜è¿™ä¸ªå®ç°å¤§æ¦‚æ˜¯æ€ä¹ˆå›äº‹ï¼›æˆ‘ä»¬è¿™é‡Œå†ä¸€æ¬¡ä½¿ç”¨äº†å¡«å……ç¬¦ token ä¸º 0 çš„æ€§è´¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘é‡åŒ– logits å’Œç›®æ ‡</span></span><br><span class="line">targets = tf.reshape(targets, [<span class="number">-1</span>]) <span class="comment"># å°†å¼ é‡ targets è½¬ä¸ºå‘é‡</span></span><br><span class="line">losses = tf.nn.sparse_softmax_cross_entropy_with_logits(logits, targets)</span><br><span class="line">mask = tf.sign.(tf.to_float(targets)) <span class="comment"># targets ä¸º 0 åˆ™è¾“å‡ºä¸º 0, target &lt; 0 åˆ™è¾“å‡ºä¸º -1, å¦åˆ™ ä¸º 1</span></span><br><span class="line">masked_losses = mask*losses <span class="comment"># å¡«å……ç¬¦æ‰€åœ¨ä½ç½®çš„è´¡çŒ®ä¸º 0</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæˆ‘ä»¬è¦å°† logits å’Œ targets å‘é‡åŒ–ã€‚ä¸ºäº†ä½¿ logits å‘é‡åŒ–ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åŠæ³•æ˜¯å°† <code>dynamic_rnn</code> çš„è¾“å‡ºå‘é‡åŒ–ä¸º <code>[-1ï¼Œnum_hidden_units]</code> çš„å½¢çŠ¶ï¼Œç„¶åä¹˜ä»¥ softmax æƒé‡ <code>[num_hidden_unitsï¼Œnum_classes]</code>ã€‚é€šè¿‡æŸå¤±å±è”½æ“ä½œï¼Œå°±å¯ä»¥æ¶ˆé™¤å¡«å……ç¬¦æ‰€åœ¨ä½ç½®è´¡çŒ®çš„æŸå¤±ã€‚</p>
<h2 id="å¼ é‡å½¢çŠ¶å˜åŒ–çš„å‚è€ƒ"><a href="#å¼ é‡å½¢çŠ¶å˜åŒ–çš„å‚è€ƒ" class="headerlink" title="å¼ é‡å½¢çŠ¶å˜åŒ–çš„å‚è€ƒ"></a>å¼ é‡å½¢çŠ¶å˜åŒ–çš„å‚è€ƒ</h2><p>åŸå§‹æœªå¤„ç†è¿‡çš„æ–‡æœ¬ <code>X</code> å½¢çŠ¶ä¸º <code>[N,]</code> è€Œ <code>y</code> çš„å½¢çŠ¶ä¸º <code>[N, C]</code>ï¼Œå…¶ä¸­ <code>C</code> æ˜¯è¾“å‡ºç±»åˆ«çš„æ•°é‡ï¼ˆè¿™äº›æ˜¯æ‰‹åŠ¨å®Œæˆçš„ï¼Œä½†æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç‹¬çƒ­ç¼–ç æ¥å¤„ç†å¤šç±»æƒ…å†µï¼‰ã€‚</p>
<p>ç„¶å <code>X</code> è¢«è½¬åŒ–ä¸º token å¹¶è¿›è¡Œå¡«å……ï¼Œå˜æˆäº† <code>[N, ]</code>ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¼ é€’å½¢çŠ¶ä¸º <code>[N,]</code> çš„ <code>seq_len</code> å‚æ•°ï¼ŒåŒ…å«æ¯ä¸ªå¥å­çš„é•¿åº¦ã€‚</p>
<p>ç°åœ¨ <code>X</code>ã€<code>seq_len</code> å’Œ <code>y</code> é€šè¿‡è¿™ä¸ªæ¨¡å‹é¦–å…ˆåµŒå…¥ä¸º <code>[NXD]</code>ï¼Œå…¶ä¸­ D æ˜¯åµŒå…¥ç»´åº¦ã€‚<code>X</code> ä¾¿ä» <code>[N, ]</code> è½¬æ¢ä¸ºäº† <code>[N, , D]</code>ã€‚å›æƒ³ä¸€ä¸‹ï¼ŒX åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªä¸­é—´è¡¨ç¤ºï¼Œå®ƒè¢«ç‹¬çƒ­ç¼–ç ä¸ºäº† <code>[N, , ]</code>ã€‚ä½†æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆåšï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨å¯¹åº”è¯çš„ç´¢å¼•ï¼Œç„¶åä»è¯åµŒå…¥æƒé‡ä¸­å–å€¼å°±å¯ä»¥äº†ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªåµŒå…¥åçš„ <code>X</code> ä¼ é€’ç»™ <code>dynamic_rnn</code> å¹¶è¿”å› <code>all_outputs</code> ï¼ˆ<code>[N, , D]</code>ï¼‰ä»¥åŠ <code>state</code>ï¼ˆ<code>[1, N, D]</code>ï¼‰ã€‚ç”±äºæˆ‘ä»¬è¾“å…¥äº† <code>seq_lens</code>ï¼Œå¯¹äºæˆ‘ä»¬è€Œè¨€å®ƒå°±æ˜¯æœ€åä¸€ä¸ªå¯¹åº”çš„çŠ¶æ€ã€‚ä»ç»´åº¦çš„è§’åº¦æ¥è¯´ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œ <code>all_outputs</code> å°±æ˜¯æ¥è‡ª RNN çš„å¯¹äºæ¯ä¸ªå¥å­ä¸­çš„æ¯ä¸ªè¯çš„å…¨éƒ¨è¾“å‡ºç»“æœã€‚ç„¶è€Œï¼Œ<code>state</code> ä»…ä»…åªæ˜¯æ¯ä¸ªå¥å­çš„æœ€åä¸€ä¸ªå¯¹åº”è¾“å‡ºã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬è¦è¾“å…¥ softmax æƒé‡ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å–ç¬¬ä¸€ä¸ªç´¢å¼•ï¼ˆ<code>state[0]</code>ï¼‰æ¥æŠŠçŠ¶æ€ä» <code>[1,N,D]</code> è½¬æ¢ä¸º<code>[N,D]</code>ã€‚å¦‚æ­¤ä¾¿å¯ä»¥é€šè¿‡ä¸ softmax æƒé‡ <code>[D,C]</code> çš„ç‚¹ç§¯ï¼Œæ¥å¾—åˆ°å½¢çŠ¶ä¸º <code>[N,C]</code> çš„è¾“å‡ºã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬åšæŒ‡æ•°çº§ softmax è¿ç®—ï¼Œç„¶åè¿›è¡Œæ­£åˆ™åŒ–ï¼Œæœ€ç»ˆç»“åˆå½¢çŠ¶ä¸º <code>[N,C]</code> çš„ <code>target_y</code> æ¥è®¡ç®—æŸå¤±å‡½æ•°ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœä½ ä½¿ç”¨äº†åŸºæœ¬çš„ RNN æˆ–è€… GRUï¼Œä» <code>dynamic_rnn</code> è¿”å›çš„ <code>all_outputs</code> å’Œ <code>state</code> çš„å½¢çŠ¶æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨ LSTM çš„è¯ï¼Œ<code>all_outputs</code> çš„å½¢çŠ¶å°±æ˜¯ <code>[N, , D]</code> è€Œ <code>state</code> çš„å½¢çŠ¶ä¸º <code>[1, 2, N, D]</code>ã€‚</p>

    </div>

    
        <hr class="fhr">
        <div id="vcomments"></div>
    
</div>
    <div class="footer" id="footer">
    <p><h4>Copyright Â© 2020 | Author: LiuXunzhuo | Theme: Hexo-Coder</h4>
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="NOsswOncKgc8HOxqo9oxIWlX-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="z1FihjWEbS8uIfUQdmCtK7zz">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>